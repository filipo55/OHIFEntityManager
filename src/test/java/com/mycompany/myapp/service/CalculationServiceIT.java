package com.mycompany.myapp.service;


import com.mycompany.myapp.OhifEntityManagerApp;
import com.mycompany.myapp.config.TestSecurityConfiguration;
import org.json.JSONObject;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.xml.sax.SAXException;

import org.springframework.util.Assert;
import javax.xml.parsers.ParserConfigurationException;
import java.io.IOException;

import static org.assertj.core.api.Assertions.*;

@SpringBootTest(classes = {OhifEntityManagerApp.class, TestSecurityConfiguration.class})
public class CalculationServiceIT {



    @Autowired
    private CalculationService calculationService;


    @Test
    public void OneLesionArea() throws IOException, SAXException, ParserConfigurationException {
        JSONObject obj = new JSONObject("{\"projectId\":\"prostatex\",\"subjectId\":\"XNAT_S00004\",\"experimentId\":\"XNAT_E00004\",\"scanId\":3,\"voxelZ\":3,\"xml\":\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<ImageAnnotationCollection xmlns=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM\\\" xmlns:rdf=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" aimVersion=\\\"AIMv4_0\\\" xsi:schemaLocation=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM AIM_v4_rv44_XML.xsd\\\">\\n    <uniqueIdentifier root=\\\"c.3.d.3.2.5.3687.87b.4.8.483af6b4b1e5df6f41bc913b3c4c331a55c36f6\\\"/>\\n    <dateTime value=\\\"20191113151928\\\"/>\\n    <description value=\\\"Lesion1\\\"/>\\n    <user>\\n        <name/>\\n        <loginName/>\\n        <roleInTrial/>\\n    </user>\\n    <equipment>\\n        <manufacturerName value=\\\"SIEMENS\\\"/>\\n        <manufacturerModelName value=\\\"Skyra\\\"/>\\n        <softwareVersion value=\\\"syngo MR D11\\\"/>\\n    </equipment>\\n    <person>\\n        <name value=\\\"ProstateX-0004\\\"/>\\n        <id value=\\\"ProstateX-0004\\\"/>\\n        <birthDate/>\\n        <sex value=\\\"M\\\"/>\\n        <ethnicGroup/>\\n    </person>\\n    <imageAnnotations>\\n        <ImageAnnotation>\\n            <uniqueIdentifier root=\\\"4.2.7.7.a.d.039a.e2c.a.9.a87ffab647f26d1b2206dc561c2d9e59c0c2cf5\\\"/>\\n            <typeCode code=\\\"AnyClosedShape\\\" codeSystem=\\\" \\\" codeSystemName=\\\" \\\" codeSystemVersion=\\\" \\\"/>\\n            <dateTime value=\\\"20191113151928\\\"/>\\n            <name value=\\\"Lesion1\\\"/>\\n            <markupEntityCollection>\\n                <MarkupEntity xsi:type=\\\"TwoDimensionPolyline\\\">\\n                    <uniqueIdentifier root=\\\"3.e.b.7.9.9.63ff.3c8.2.f.51d448b9f81c7b2ef1b66867286f288d5ff9cca\\\"/>\\n                    <shapeIdentifier value=\\\"0\\\"/>\\n                    <includeFlag value=\\\"true\\\"/>\\n                    <imageReferenceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.294081267725134067317791529279\\\"/>\\n                    <referencedFrameNumber value=\\\"1\\\"/>\\n                    <twoDimensionSpatialCoordinateCollection>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"136.5137614678899\\\"/>\\n                            <y value=\\\"46.972477064220215\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"1\\\"/>\\n                            <x value=\\\"51.37614678899083\\\"/>\\n                            <y value=\\\"234.86238532110096\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"2\\\"/>\\n                            <x value=\\\"264.22018348623857\\\"/>\\n                            <y value=\\\"253.9449541284404\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"3\\\"/>\\n                            <x value=\\\"264.22018348623857\\\"/>\\n                            <y value=\\\"252.4770642201835\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"136.5137614678899\\\"/>\\n                            <y value=\\\"46.972477064220215\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                    </twoDimensionSpatialCoordinateCollection>\\n                </MarkupEntity>\\n                <MarkupEntity xsi:type=\\\"TwoDimensionPolyline\\\">\\n                    <uniqueIdentifier root=\\\"0.3.f.e.5.b.eb06.a4f.5.c.31c4d919fc118334df1f4c4f69d6673ce46eca2\\\"/>\\n                    <shapeIdentifier value=\\\"1\\\"/>\\n                    <includeFlag value=\\\"true\\\"/>\\n                    <imageReferenceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.161508750651322589515431094597\\\"/>\\n                    <referencedFrameNumber value=\\\"1\\\"/>\\n                    <twoDimensionSpatialCoordinateCollection>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"140.91743119266056\\\"/>\\n                            <y value=\\\"76.33027522935785\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"1\\\"/>\\n                            <x value=\\\"88.07339449541286\\\"/>\\n                            <y value=\\\"274.49541284403676\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"2\\\"/>\\n                            <x value=\\\"262.7522935779817\\\"/>\\n                            <y value=\\\"230.45871559633034\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"140.91743119266056\\\"/>\\n                            <y value=\\\"76.33027522935785\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                    </twoDimensionSpatialCoordinateCollection>\\n                </MarkupEntity>\\n            </markupEntityCollection>\\n            <imageReferenceEntityCollection>\\n                <ImageReferenceEntity xsi:type=\\\"DicomImageReferenceEntity\\\">\\n                    <uniqueIdentifier root=\\\"1.b.8.8.b.2.e62f.497.5.e.2ce8577d211db1b7b7c44f47c4e847a5d2d3c7f\\\"/>\\n                    <imageStudy>\\n                        <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.170561193612723093192571245493\\\"/>\\n                        <startDate value=\\\"20111018\\\"/>\\n                        <startTime value=\\\"114505.406000\\\"/>\\n                        <imageSeries>\\n                            <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.473042633347744664896320600386\\\"/>\\n                            <modality code=\\\"MR\\\" codeSystem=\\\"1.2.840.10008.2.16.4\\\" codeSystemName=\\\"DCM\\\" codeSystemVersion=\\\"01\\\"/>\\n                            <imageCollection>\\n                                <Image>\\n                                    <sopClassUid root=\\\"1.2.840.10008.5.1.4.1.1.4\\\"/>\\n                                    <sopInstanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.294081267725134067317791529279\\\"/>\\n                                </Image>\\n                                <Image>\\n                                    <sopClassUid root=\\\"1.2.840.10008.5.1.4.1.1.4\\\"/>\\n                                    <sopInstanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.161508750651322589515431094597\\\"/>\\n                                </Image>\\n                            </imageCollection>\\n                        </imageSeries>\\n                    </imageStudy>\\n                </ImageReferenceEntity>\\n            </imageReferenceEntityCollection>\\n        </ImageAnnotation>\\n    </imageAnnotations>\\n</ImageAnnotationCollection>\"}");
        String xml =  obj.getString("xml");
        double result = calculationService.CalculateDataFromFile(xml,"Lesion1");
        //Assert.isTrue(result == 20901.674774169922, "Test failed");
        assertThat(result == 20901.674774169922);
    }

    @Test
    public void OneLesionVolume() throws IOException, SAXException, ParserConfigurationException {
        JSONObject obj = new JSONObject("{\"projectId\":\"prostatex\",\"subjectId\":\"XNAT_S00004\",\"experimentId\":\"XNAT_E00004\",\"scanId\":3,\"voxelZ\":3,\"xml\":\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<ImageAnnotationCollection xmlns=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM\\\" xmlns:rdf=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" aimVersion=\\\"AIMv4_0\\\" xsi:schemaLocation=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM AIM_v4_rv44_XML.xsd\\\">\\n    <uniqueIdentifier root=\\\"c.3.d.3.2.5.3687.87b.4.8.483af6b4b1e5df6f41bc913b3c4c331a55c36f6\\\"/>\\n    <dateTime value=\\\"20191113151928\\\"/>\\n    <description value=\\\"Lesion1\\\"/>\\n    <user>\\n        <name/>\\n        <loginName/>\\n        <roleInTrial/>\\n    </user>\\n    <equipment>\\n        <manufacturerName value=\\\"SIEMENS\\\"/>\\n        <manufacturerModelName value=\\\"Skyra\\\"/>\\n        <softwareVersion value=\\\"syngo MR D11\\\"/>\\n    </equipment>\\n    <person>\\n        <name value=\\\"ProstateX-0004\\\"/>\\n        <id value=\\\"ProstateX-0004\\\"/>\\n        <birthDate/>\\n        <sex value=\\\"M\\\"/>\\n        <ethnicGroup/>\\n    </person>\\n    <imageAnnotations>\\n        <ImageAnnotation>\\n            <uniqueIdentifier root=\\\"4.2.7.7.a.d.039a.e2c.a.9.a87ffab647f26d1b2206dc561c2d9e59c0c2cf5\\\"/>\\n            <typeCode code=\\\"AnyClosedShape\\\" codeSystem=\\\" \\\" codeSystemName=\\\" \\\" codeSystemVersion=\\\" \\\"/>\\n            <dateTime value=\\\"20191113151928\\\"/>\\n            <name value=\\\"Lesion1\\\"/>\\n            <markupEntityCollection>\\n                <MarkupEntity xsi:type=\\\"TwoDimensionPolyline\\\">\\n                    <uniqueIdentifier root=\\\"3.e.b.7.9.9.63ff.3c8.2.f.51d448b9f81c7b2ef1b66867286f288d5ff9cca\\\"/>\\n                    <shapeIdentifier value=\\\"0\\\"/>\\n                    <includeFlag value=\\\"true\\\"/>\\n                    <imageReferenceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.294081267725134067317791529279\\\"/>\\n                    <referencedFrameNumber value=\\\"1\\\"/>\\n                    <twoDimensionSpatialCoordinateCollection>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"136.5137614678899\\\"/>\\n                            <y value=\\\"46.972477064220215\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"1\\\"/>\\n                            <x value=\\\"51.37614678899083\\\"/>\\n                            <y value=\\\"234.86238532110096\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"2\\\"/>\\n                            <x value=\\\"264.22018348623857\\\"/>\\n                            <y value=\\\"253.9449541284404\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"3\\\"/>\\n                            <x value=\\\"264.22018348623857\\\"/>\\n                            <y value=\\\"252.4770642201835\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"136.5137614678899\\\"/>\\n                            <y value=\\\"46.972477064220215\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                    </twoDimensionSpatialCoordinateCollection>\\n                </MarkupEntity>\\n                <MarkupEntity xsi:type=\\\"TwoDimensionPolyline\\\">\\n                    <uniqueIdentifier root=\\\"0.3.f.e.5.b.eb06.a4f.5.c.31c4d919fc118334df1f4c4f69d6673ce46eca2\\\"/>\\n                    <shapeIdentifier value=\\\"1\\\"/>\\n                    <includeFlag value=\\\"true\\\"/>\\n                    <imageReferenceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.161508750651322589515431094597\\\"/>\\n                    <referencedFrameNumber value=\\\"1\\\"/>\\n                    <twoDimensionSpatialCoordinateCollection>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"140.91743119266056\\\"/>\\n                            <y value=\\\"76.33027522935785\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"1\\\"/>\\n                            <x value=\\\"88.07339449541286\\\"/>\\n                            <y value=\\\"274.49541284403676\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"2\\\"/>\\n                            <x value=\\\"262.7522935779817\\\"/>\\n                            <y value=\\\"230.45871559633034\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"140.91743119266056\\\"/>\\n                            <y value=\\\"76.33027522935785\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                    </twoDimensionSpatialCoordinateCollection>\\n                </MarkupEntity>\\n            </markupEntityCollection>\\n            <imageReferenceEntityCollection>\\n                <ImageReferenceEntity xsi:type=\\\"DicomImageReferenceEntity\\\">\\n                    <uniqueIdentifier root=\\\"1.b.8.8.b.2.e62f.497.5.e.2ce8577d211db1b7b7c44f47c4e847a5d2d3c7f\\\"/>\\n                    <imageStudy>\\n                        <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.170561193612723093192571245493\\\"/>\\n                        <startDate value=\\\"20111018\\\"/>\\n                        <startTime value=\\\"114505.406000\\\"/>\\n                        <imageSeries>\\n                            <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.473042633347744664896320600386\\\"/>\\n                            <modality code=\\\"MR\\\" codeSystem=\\\"1.2.840.10008.2.16.4\\\" codeSystemName=\\\"DCM\\\" codeSystemVersion=\\\"01\\\"/>\\n                            <imageCollection>\\n                                <Image>\\n                                    <sopClassUid root=\\\"1.2.840.10008.5.1.4.1.1.4\\\"/>\\n                                    <sopInstanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.294081267725134067317791529279\\\"/>\\n                                </Image>\\n                                <Image>\\n                                    <sopClassUid root=\\\"1.2.840.10008.5.1.4.1.1.4\\\"/>\\n                                    <sopInstanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.161508750651322589515431094597\\\"/>\\n                                </Image>\\n                            </imageCollection>\\n                        </imageSeries>\\n                    </imageStudy>\\n                </ImageReferenceEntity>\\n            </imageReferenceEntityCollection>\\n        </ImageAnnotation>\\n    </imageAnnotations>\\n</ImageAnnotationCollection>\"}");
        String xml =  obj.getString("xml");
        int height = obj.getInt("voxelZ");
        double area = calculationService.CalculateDataFromFile(xml,"Lesion1");
        double volume = calculationService.CalculateVolume(area,height);
        //Assert.isTrue(volume == 62705.024322509766, "Test failed");
        assertThat(volume == 62705.024322509766);
    }

    @Test
    public void OneProstateArea() throws IOException, SAXException, ParserConfigurationException {
        JSONObject obj = new JSONObject("{\"projectId\":\"prostatex\",\"subjectId\":\"XNAT_S00004\",\"experimentId\":\"XNAT_E00004\",\"scanId\":3,\"voxelZ\":3,\"xml\":\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<ImageAnnotationCollection xmlns=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM\\\" xmlns:rdf=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" aimVersion=\\\"AIMv4_0\\\" xsi:schemaLocation=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM AIM_v4_rv44_XML.xsd\\\">\\n    <uniqueIdentifier root=\\\"6.6.4.2.c.2.865b.9f0.3.1.6de2195d50c56afe50cad631821e9b45e613e19\\\"/>\\n    <dateTime value=\\\"20191113153003\\\"/>\\n    <description value=\\\"Prostate\\\"/>\\n    <user>\\n        <name/>\\n        <loginName/>\\n        <roleInTrial/>\\n    </user>\\n    <equipment>\\n        <manufacturerName value=\\\"SIEMENS\\\"/>\\n        <manufacturerModelName value=\\\"Skyra\\\"/>\\n        <softwareVersion value=\\\"syngo MR D11\\\"/>\\n    </equipment>\\n    <person>\\n        <name value=\\\"ProstateX-0004\\\"/>\\n        <id value=\\\"ProstateX-0004\\\"/>\\n        <birthDate/>\\n        <sex value=\\\"M\\\"/>\\n        <ethnicGroup/>\\n    </person>\\n    <imageAnnotations>\\n        <ImageAnnotation>\\n            <uniqueIdentifier root=\\\"3.6.f.2.7.5.cae1.c1f.4.e.c49b35b6ca530ad5ca2b20587b82a393c5b7848\\\"/>\\n            <typeCode code=\\\"AnyClosedShape\\\" codeSystem=\\\" \\\" codeSystemName=\\\" \\\" codeSystemVersion=\\\" \\\"/>\\n            <dateTime value=\\\"20191113153003\\\"/>\\n            <name value=\\\"Prostate\\\"/>\\n            <markupEntityCollection>\\n                <MarkupEntity xsi:type=\\\"TwoDimensionPolyline\\\">\\n                    <uniqueIdentifier root=\\\"e.0.9.1.0.c.82d3.c8c.2.2.8426f19e76fd8be52d464a55db4d183cf096a9d\\\"/>\\n                    <shapeIdentifier value=\\\"0\\\"/>\\n                    <includeFlag value=\\\"true\\\"/>\\n                    <imageReferenceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.233075306282180876985872122049\\\"/>\\n                    <referencedFrameNumber value=\\\"1\\\"/>\\n                    <twoDimensionSpatialCoordinateCollection>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"134.73684210526318\\\"/>\\n                            <y value=\\\"88.74493927125508\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"1\\\"/>\\n                            <x value=\\\"44.04858299595143\\\"/>\\n                            <y value=\\\"139.27125506072878\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"2\\\"/>\\n                            <x value=\\\"87.44939271255062\\\"/>\\n                            <y value=\\\"237.08502024291502\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"3\\\"/>\\n                            <x value=\\\"176.84210526315792\\\"/>\\n                            <y value=\\\"270.1214574898786\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"4\\\"/>\\n                            <x value=\\\"242.26720647773283\\\"/>\\n                            <y value=\\\"185.91093117408911\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"5\\\"/>\\n                            <x value=\\\"255.8704453441296\\\"/>\\n                            <y value=\\\"117.89473684210529\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"6\\\"/>\\n                            <x value=\\\"254.57489878542515\\\"/>\\n                            <y value=\\\"114.00809716599193\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"7\\\"/>\\n                            <x value=\\\"253.9271255060729\\\"/>\\n                            <y value=\\\"110.76923076923077\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"8\\\"/>\\n                            <x value=\\\"253.2793522267207\\\"/>\\n                            <y value=\\\"109.47368421052633\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"9\\\"/>\\n                            <x value=\\\"248.7449392712551\\\"/>\\n                            <y value=\\\"104.29149797570852\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"10\\\"/>\\n                            <x value=\\\"187.8542510121458\\\"/>\\n                            <y value=\\\"88.74493927125508\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"11\\\"/>\\n                            <x value=\\\"183.96761133603243\\\"/>\\n                            <y value=\\\"88.09716599190284\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"12\\\"/>\\n                            <x value=\\\"182.02429149797575\\\"/>\\n                            <y value=\\\"88.09716599190284\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"13\\\"/>\\n                            <x value=\\\"174.89878542510124\\\"/>\\n                            <y value=\\\"85.50607287449394\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"134.73684210526318\\\"/>\\n                            <y value=\\\"88.74493927125508\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                    </twoDimensionSpatialCoordinateCollection>\\n                </MarkupEntity>\\n            </markupEntityCollection>\\n            <imageReferenceEntityCollection>\\n                <ImageReferenceEntity xsi:type=\\\"DicomImageReferenceEntity\\\">\\n                    <uniqueIdentifier root=\\\"d.3.7.9.d.6.117c.054.9.f.44baca5e528b083950d1a5acf9be0ca58725dd2\\\"/>\\n                    <imageStudy>\\n                        <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.170561193612723093192571245493\\\"/>\\n                        <startDate value=\\\"20111018\\\"/>\\n                        <startTime value=\\\"114505.406000\\\"/>\\n                        <imageSeries>\\n                            <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.473042633347744664896320600386\\\"/>\\n                            <modality code=\\\"MR\\\" codeSystem=\\\"1.2.840.10008.2.16.4\\\" codeSystemName=\\\"DCM\\\" codeSystemVersion=\\\"01\\\"/>\\n                            <imageCollection>\\n                                <Image>\\n                                    <sopClassUid root=\\\"1.2.840.10008.5.1.4.1.1.4\\\"/>\\n                                    <sopInstanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.233075306282180876985872122049\\\"/>\\n                                </Image>\\n                            </imageCollection>\\n                        </imageSeries>\\n                    </imageStudy>\\n                </ImageReferenceEntity>\\n            </imageReferenceEntityCollection>\\n        </ImageAnnotation>\\n    </imageAnnotations>\\n</ImageAnnotationCollection>\"}");
        String xml =  obj.getString("xml");
        double result = calculationService.CalculateDataFromFile(xml,"Prostate");
        //Assert.isTrue(result == 26193.957145690918, "Test failed");
        assertThat(result == 26193.957145690918);
    }

    @Test
    public void OneProstateVolume() throws IOException, SAXException, ParserConfigurationException {
        JSONObject obj = new JSONObject("{\"projectId\":\"prostatex\",\"subjectId\":\"XNAT_S00004\",\"experimentId\":\"XNAT_E00004\",\"scanId\":3,\"voxelZ\":3,\"xml\":\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<ImageAnnotationCollection xmlns=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM\\\" xmlns:rdf=\\\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" aimVersion=\\\"AIMv4_0\\\" xsi:schemaLocation=\\\"gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM AIM_v4_rv44_XML.xsd\\\">\\n    <uniqueIdentifier root=\\\"6.6.4.2.c.2.865b.9f0.3.1.6de2195d50c56afe50cad631821e9b45e613e19\\\"/>\\n    <dateTime value=\\\"20191113153003\\\"/>\\n    <description value=\\\"Prostate\\\"/>\\n    <user>\\n        <name/>\\n        <loginName/>\\n        <roleInTrial/>\\n    </user>\\n    <equipment>\\n        <manufacturerName value=\\\"SIEMENS\\\"/>\\n        <manufacturerModelName value=\\\"Skyra\\\"/>\\n        <softwareVersion value=\\\"syngo MR D11\\\"/>\\n    </equipment>\\n    <person>\\n        <name value=\\\"ProstateX-0004\\\"/>\\n        <id value=\\\"ProstateX-0004\\\"/>\\n        <birthDate/>\\n        <sex value=\\\"M\\\"/>\\n        <ethnicGroup/>\\n    </person>\\n    <imageAnnotations>\\n        <ImageAnnotation>\\n            <uniqueIdentifier root=\\\"3.6.f.2.7.5.cae1.c1f.4.e.c49b35b6ca530ad5ca2b20587b82a393c5b7848\\\"/>\\n            <typeCode code=\\\"AnyClosedShape\\\" codeSystem=\\\" \\\" codeSystemName=\\\" \\\" codeSystemVersion=\\\" \\\"/>\\n            <dateTime value=\\\"20191113153003\\\"/>\\n            <name value=\\\"Prostate\\\"/>\\n            <markupEntityCollection>\\n                <MarkupEntity xsi:type=\\\"TwoDimensionPolyline\\\">\\n                    <uniqueIdentifier root=\\\"e.0.9.1.0.c.82d3.c8c.2.2.8426f19e76fd8be52d464a55db4d183cf096a9d\\\"/>\\n                    <shapeIdentifier value=\\\"0\\\"/>\\n                    <includeFlag value=\\\"true\\\"/>\\n                    <imageReferenceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.233075306282180876985872122049\\\"/>\\n                    <referencedFrameNumber value=\\\"1\\\"/>\\n                    <twoDimensionSpatialCoordinateCollection>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"134.73684210526318\\\"/>\\n                            <y value=\\\"88.74493927125508\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"1\\\"/>\\n                            <x value=\\\"44.04858299595143\\\"/>\\n                            <y value=\\\"139.27125506072878\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"2\\\"/>\\n                            <x value=\\\"87.44939271255062\\\"/>\\n                            <y value=\\\"237.08502024291502\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"3\\\"/>\\n                            <x value=\\\"176.84210526315792\\\"/>\\n                            <y value=\\\"270.1214574898786\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"4\\\"/>\\n                            <x value=\\\"242.26720647773283\\\"/>\\n                            <y value=\\\"185.91093117408911\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"5\\\"/>\\n                            <x value=\\\"255.8704453441296\\\"/>\\n                            <y value=\\\"117.89473684210529\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"6\\\"/>\\n                            <x value=\\\"254.57489878542515\\\"/>\\n                            <y value=\\\"114.00809716599193\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"7\\\"/>\\n                            <x value=\\\"253.9271255060729\\\"/>\\n                            <y value=\\\"110.76923076923077\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"8\\\"/>\\n                            <x value=\\\"253.2793522267207\\\"/>\\n                            <y value=\\\"109.47368421052633\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"9\\\"/>\\n                            <x value=\\\"248.7449392712551\\\"/>\\n                            <y value=\\\"104.29149797570852\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"10\\\"/>\\n                            <x value=\\\"187.8542510121458\\\"/>\\n                            <y value=\\\"88.74493927125508\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"11\\\"/>\\n                            <x value=\\\"183.96761133603243\\\"/>\\n                            <y value=\\\"88.09716599190284\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"12\\\"/>\\n                            <x value=\\\"182.02429149797575\\\"/>\\n                            <y value=\\\"88.09716599190284\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"13\\\"/>\\n                            <x value=\\\"174.89878542510124\\\"/>\\n                            <y value=\\\"85.50607287449394\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                        <TwoDimensionSpatialCoordinate>\\n                            <coordinateIndex value=\\\"0\\\"/>\\n                            <x value=\\\"134.73684210526318\\\"/>\\n                            <y value=\\\"88.74493927125508\\\"/>\\n                        </TwoDimensionSpatialCoordinate>\\n                    </twoDimensionSpatialCoordinateCollection>\\n                </MarkupEntity>\\n            </markupEntityCollection>\\n            <imageReferenceEntityCollection>\\n                <ImageReferenceEntity xsi:type=\\\"DicomImageReferenceEntity\\\">\\n                    <uniqueIdentifier root=\\\"d.3.7.9.d.6.117c.054.9.f.44baca5e528b083950d1a5acf9be0ca58725dd2\\\"/>\\n                    <imageStudy>\\n                        <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.170561193612723093192571245493\\\"/>\\n                        <startDate value=\\\"20111018\\\"/>\\n                        <startTime value=\\\"114505.406000\\\"/>\\n                        <imageSeries>\\n                            <instanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.473042633347744664896320600386\\\"/>\\n                            <modality code=\\\"MR\\\" codeSystem=\\\"1.2.840.10008.2.16.4\\\" codeSystemName=\\\"DCM\\\" codeSystemVersion=\\\"01\\\"/>\\n                            <imageCollection>\\n                                <Image>\\n                                    <sopClassUid root=\\\"1.2.840.10008.5.1.4.1.1.4\\\"/>\\n                                    <sopInstanceUid root=\\\"1.3.6.1.4.1.14519.5.2.1.7311.5101.233075306282180876985872122049\\\"/>\\n                                </Image>\\n                            </imageCollection>\\n                        </imageSeries>\\n                    </imageStudy>\\n                </ImageReferenceEntity>\\n            </imageReferenceEntityCollection>\\n        </ImageAnnotation>\\n    </imageAnnotations>\\n</ImageAnnotationCollection>\"}");
        String xml =  obj.getString("xml");
        int height = obj.getInt("voxelZ");
        double area = calculationService.CalculateDataFromFile(xml,"Prostate");
        double volume = calculationService.CalculateVolume(area,height);
        //Assert.isTrue(volume == 78581.87143707275, "Test failed");
        assertThat(volume == 78581.87143707275);
    }


}
